<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æç”»æ©Ÿèƒ½ä»˜ããƒ¡ãƒ¢å¸³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&family=Klee+One&family=Mochiy+Pop+P+One&family=Potta+One&family=Rampart+One&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š */
    :root {
      --theme-color: #0078d4; /* Word Blue */
      --theme-hover: #005a9e;
      --ribbon-bg: #f0f0f0;
      --tab-bar-bg: white;
      --editor-bg: #fff;
      --ribbon-height: 80px; /* ã‚¿ãƒ–ãƒãƒ¼ã¨ãƒ‘ãƒãƒ«ã®åˆè¨ˆé«˜ã•ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«èª¿æ•´ */
      --file-menu-width: 280px;
      --file-menu-bg: #2b2b2b;
      --modal-bg: #fff;
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e5e5e5;
    }

    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆã®é©ç”¨ */
    .font-arial { font-family: Arial, sans-serif; }
    .font-hachi-maru-pop { font-family: 'Hachi Maru Pop', cursive; }
    .font-potta-one { font-family: 'Potta One', cursive; }
    .font-klee-one { font-family: 'Klee One', cursive; }
    .font-rampart-one { font-family: 'Rampart One', cursive; }
    .font-mochiy-pop-p-one { font-family: 'Mochiy Pop P One', sans-serif; }
    
    /* --- ãƒˆãƒƒãƒ—ãƒãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ (ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ã¨ã‚¿ãƒ–ãƒãƒ¼ã‚’å«ã‚€) --- */
    .top-bar-container {
      display: flex;
      align-items: flex-end;
      background-color: var(--tab-bar-bg);
      border-bottom: 1px solid #ccc;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      user-select: none;
    }

    /* --- ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ (ã‚¿ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã«çµ±ä¸€) --- */
    .file-button {
      padding: 8px 15px;
      margin-left: 10px;
      margin-right: 5px;
      border: none;
      background-color: transparent;
      color: #333;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      border-radius: 4px 4px 0 0;
      transition: all 0.2s;
      height: 38px;
      box-sizing: border-box;
    }

    .file-button:hover {
        background-color: #e0e0e0;
    }

    .file-button.active {
      background-color: var(--ribbon-bg);
      border-bottom: 3px solid var(--theme-color);
      color: #000;
      font-weight: 600;
    }

    /* --- ãƒªãƒœãƒ³å…¨ä½“ --- */
    .ribbon-container {
      background-color: var(--ribbon-bg);
      border-bottom: 1px solid #ccc;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      user-select: none;
    }

    /* --- ã‚¿ãƒ–ãƒãƒ¼ (ãƒ›ãƒ¼ãƒ ã€æŒ¿å…¥ã€è¡¨ç¤º, æç”») --- */
    .tab-bar {
      display: flex;
      padding: 0 10px;
      height: 38px;
    }

    .tab-button {
      padding: 8px 15px;
      border: none;
      background-color: transparent;
      color: #333;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.2s;
      border-radius: 4px 4px 0 0;
      margin-right: 2px;
    }

    .tab-button:hover {
      background-color: #e0e0e0;
    }

    .tab-button.active {
      background-color: var(--ribbon-bg);
      border-bottom: 3px solid var(--theme-color);
      color: #000;
      font-weight: 600;
    }

    /* --- ã‚¿ãƒ–ãƒ‘ãƒãƒ« (ãƒ„ãƒ¼ãƒ«ã®æœ¬ä½“) --- */
    .tab-panel {
      display: flex;
      padding: 8px 15px;
      gap: 15px;
      align-items: center; /* ãƒ„ãƒ¼ãƒ«ã‚’ä¸­å¤®ã«æƒãˆã‚‹ */
      height: 40px; /* ãƒ‘ãƒãƒ«ã®é«˜ã•ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
    }

    /* --- ã‚°ãƒ«ãƒ¼ãƒ— (ãƒ•ã‚©ãƒ³ãƒˆã€æ®µè½ãªã©) --- */
    .ribbon-group {
      display: flex; /* ã“ã‚Œã«ã‚ˆã‚Šãƒ„ãƒ¼ãƒ«ãŒæ¨ªã«ä¸¦ã¶ */
      flex-direction: row; /* æ°´å¹³ã«ä¸¦ã¹ã‚‹ */
      align-items: center;
      gap: 6px; /* ãƒ„ãƒ¼ãƒ«é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
      padding: 0 10px;
      border-right: 1px solid #ddd;
      height: 100%;
      box-sizing: border-box;
      position: relative;
    }

    .ribbon-group:last-child {
      border-right: none;
    }

    /* ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ã¯éè¡¨ç¤ºã¾ãŸã¯ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .group-label {
      display: none; /* ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¦ã€ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒªãƒœãƒ³ã‚’å®Ÿç¾ */
    }

    .ribbon-tools {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .ribbon-group button, .ribbon-group select, .ribbon-group input[type="number"] {
        padding: 4px 6px;
        font-size: 0.8em;
        background-color: white;
        color: #333;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: background-color 0.1s ease, border-color 0.1s ease;
        height: 30px;
        min-width: 30px;
        box-sizing: border-box;
    }
    
    /* ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« (é‡è¦: è¿½åŠ /å¤‰æ›´ã•ã‚ŒãŸéƒ¨åˆ†) */
    .ribbon-group button:hover {
        background-color: #e0e0e0;
        border-color: #a0a0a0;
    }
    
    .ribbon-group button.active {
        background-color: var(--theme-color);
        color: white;
        border-color: var(--theme-color);
    }
    
    /* ãƒ•ã‚©ãƒ³ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ã®å¹…ã‚’åºƒã’ã‚‹ */
    #font-selector {
        width: 150px; 
    }
    
    /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå…¥åŠ›ã¨è‰²ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å¹…ã‚’èª¿æ•´ */
    .ribbon-group select:not(#font-selector), #font-size-input {
        width: 60px; /* ã‚µã‚¤ã‚ºèª¿æ•´ */
    }
    
    /* è›å…‰ãƒšãƒ³ã‚»ãƒ¬ã‚¯ã‚¿ã®å¹…ã‚’èª¿æ•´ */
    #highlight-selector {
        width: 60px;
        padding-left: 2px;
        padding-right: 2px;
    }

    /* æ–°è¦è¿½åŠ : æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #drawing-canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10; /* ã‚¨ãƒ‡ã‚£ã‚¿ã®ä¸Šã«é‡ã­ã‚‹ */
        pointer-events: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¨ãƒ‡ã‚£ã‚¿ã®æ“ä½œã‚’å¦¨ã’ãªã„ */
    }

    /* ã‚¨ãƒ‡ã‚£ã‚¿ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .document {
      height: calc(100% - var(--ribbon-height)); /* ãƒªãƒœãƒ³ã®é«˜ã•ã‚’è€ƒæ…® */
      padding: 1em;
      box-sizing: border-box;
      position: relative; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã€ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã€ç”»åƒã‚’é‡ã­ã‚‹ãŸã‚ã®åŸºæº– */
    }

    #editor {
      width: 100%;
      height: 100%;
      background-color: var(--editor-bg);
      padding: 1em;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      box-sizing: border-box;
      overflow-y: auto;
      outline: none;
      line-height: 1.6;
      font-size: 1rem; /* 16px ç›¸å½“ */
      /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚©ãƒ³ãƒˆã‚’è¨­å®š */
      font-family: Arial, sans-serif;
      z-index: 5; /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸‹ã«é…ç½® */
      position: relative;
    }

    #editor:empty::before {
      content: "ã“ã“ã«ãƒ¡ãƒ¢ã‚’æ›¸ã„ã¦ãã ã•ã„...";
      color: #aaa;
    }
    
    /* â­ ä¿®æ­£: Draggable Element Styles (ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã®è¿½åŠ ) â­ */
    .draggable-element {
        position: absolute; /* Documentã‚³ãƒ³ãƒ†ãƒŠå†…ã§è‡ªç”±ã«é…ç½® */
        z-index: 20; /* ã‚¨ãƒ‡ã‚£ã‚¿ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¸Šã«é…ç½® */
        cursor: grab;
        border: 1px dashed #aaa;
        padding: 5px;
        box-sizing: border-box;
        background-color: rgba(255, 255, 255, 0.8);
        transition: box-shadow 0.1s, border-color 0.1s;
        border-radius: 4px;
        user-select: none;
        resize: both; /* ãƒªã‚µã‚¤ã‚ºã‚’å¯èƒ½ã«ã™ã‚‹ (ç”»åƒã€ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹å…±é€š) */
        overflow: auto; /* ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼å¯¾å¿œ */
    }
    
    .draggable-element:hover {
        border-color: var(--theme-color);
        box-shadow: 0 0 5px rgba(0, 120, 212, 0.5);
    }

    .draggable-textbox {
        min-width: 150px;
        min-height: 50px;
        padding: 8px; 
        font-family: Arial, sans-serif;
        font-size: 14px;
    }
    
    .draggable-textbox[contenteditable="true"]:focus {
        border-color: var(--theme-color);
        outline: none;
        box-shadow: 0 0 5px rgba(0, 120, 212, 0.8);
    }

    /* ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸçŠ¶æ…‹ (ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯, èµ¤ã„æ ç·š) */
    .draggable-element.pinned {
        cursor: default !important; 
        border: 1px solid red; /* ãƒ”ãƒ³ç•™ã‚ã‚’è¦–è¦šçš„ã«å¼·èª¿ */
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        opacity: 0.9;
    }
    
    /* ç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ« (ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã¦ä¼¸ç¸®ã•ã›ã‚‹) */
    .draggable-element img {
        max-width: 100%;
        max-height: 100%;
        width: 100%;
        height: 100%;
        object-fit: contain; /* ç”»åƒãŒæ­ªã¾ãªã„ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ•ã‚£ãƒƒãƒˆ */
        display: block;
        pointer-events: none; 
    }
    
    /* â­ æ–°è¦è¿½åŠ /ä¿®æ­£: ç”»åƒå‡ºåŠ›æ™‚ã«é©ç”¨ã™ã‚‹éè¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« â­ */
    .export-mode .draggable-element {
        resize: none !important; /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚’éè¡¨ç¤º */
        border: 1px solid transparent !important; /* æ ç·šã‚’é€æ˜ã«ã™ã‚‹ */
        box-shadow: none !important; /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’éè¡¨ç¤º */
        cursor: default !important; /* ã‚«ãƒ¼ã‚½ãƒ«ã‚‚éè¡¨ç¤º */
    }

    .export-mode .draggable-element.pinned {
        border-color: transparent !important; /* èµ¤ã„æ ç·šã‚‚éè¡¨ç¤º */
        box-shadow: none !important;
    }

    /* â­ æ–°è¦è¿½åŠ : ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« â­ */
    #custom-context-menu {
        position: fixed; /* bodyã«å¯¾ã—ã¦å›ºå®š */
        z-index: 10000;
        background-color: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        padding: 5px 0;
        display: none;
        list-style: none;
        margin: 0;
        border-radius: 4px;
        min-width: 180px;
    }
    
    #custom-context-menu li {
        padding: 8px 15px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #333;
        position: relative; /* ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åŸºæº– */
    }
    
    #custom-context-menu li:hover {
        background-color: var(--theme-color);
        color: white;
    }
    
    /* â­ æ–°è¦è¿½åŠ : æ ç·šè‰²ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« â­ */
    .submenu {
        position: absolute;
        top: 0;
        left: 100%;
        background-color: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        padding: 5px 0;
        display: none;
        min-width: 120px;
        border-radius: 4px;
    }
    
    #custom-context-menu li:hover > .submenu {
        display: block;
    }
    
    .submenu-color-option {
        width: 100%;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .color-swatch {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }
    
    .submenu-color-option:hover {
        background-color: #eee;
        color: #333; /* ãƒ›ãƒãƒ¼è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ */
    }


    /* --- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ) --- */
    .file-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); 
        z-index: 999;
        display: none;
        justify-content: flex-start;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .file-menu-overlay.open {
        display: flex;
        opacity: 1;
    }

    .menu-options-pane {
        width: var(--file-menu-width);
        background-color: var(--file-menu-bg);
        padding: 20px 0;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        color: white;
        
        /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š */
        transform: translateX(-100%);
        transition: transform 0.3s ease-out;
    }

    .file-menu-overlay.open .menu-options-pane {
        transform: translateX(0);
    }

    .menu-detail-pane {
        flex-grow: 1; 
    }

    .menu-option {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px 20px;
        background-color: transparent;
        color: white;
        border: none;
        text-align: left;
        font-size: 1.1em;
        cursor: pointer;
        transition: background-color 0.1s;
        width: 100%;
        box-sizing: border-box;
    }

    .menu-option:hover {
        background-color: #3b3b3b;
    }
    
    .menu-option .material-icons {
        font-size: 24px;
    }
    
    /* --- ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« (alert()ã®ä»£æ›¿) --- */
    .notification-modal {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 1000;
    }

    .notification-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    /* --- Welcome Screen (ãƒ›ãƒ¼ãƒ ç”»é¢) --- */
    #welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f7f7f7; 
      z-index: 998; 
      display: flex; 
      box-sizing: border-box;
    }
    
    .left-pane {
        width: 300px;
        background-color: white;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
    }
    
    .right-pane {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
    }

    .left-pane h2, .right-pane h2 {
        font-size: 1.8em;
        font-weight: 300;
        color: #333;
        margin-top: 0;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    /* æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ (Wordã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¢¨) */
    #new-memo-button {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 30px 15px;
        background-color: var(--theme-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 20px;
    }
    
    #new-memo-button:hover {
        background-color: var(--theme-hover);
    }

    #new-memo-button .material-icons {
        font-size: 4em;
    }

    #new-memo-button span:last-child {
        font-weight: 600;
        font-size: 1.2em;
        margin-top: 10px;
    }

    /* æœ€è¿‘ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ (å³ãƒšã‚¤ãƒ³) */
    .recent-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .recent-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.1s;
        border-radius: 4px;
        position: relative;
    }

    .recent-item:hover {
        background-color: #e0e0e0;
    }
    
    .recent-item .material-icons {
        color: var(--theme-color);
        font-size: 28px;
    }

    .recent-info {
        flex-grow: 1;
        text-align: left;
    }

    .recent-title {
        font-weight: 600;
        color: #333;
        font-size: 1.1em;
    }

    .recent-date {
        font-size: 0.85em;
        color: #777;
    }
    
    .recent-delete {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s, visibility 0.2s;
    }
    
    .recent-item:hover .recent-delete {
        visibility: visible;
        opacity: 1;
        color: #d32f2f;
    }

    /* Document View (ãƒªãƒœãƒ³ã¨ã‚¨ãƒ‡ã‚£ã‚¿å…¨ä½“) */
    #document-view-container {
        display: none;
        height: 100%;
        width: 100%;
        flex-direction: column;
    }

    /* --- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); 
        z-index: 1010;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: var(--modal-bg);
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    .modal-content h2 {
        color: var(--theme-color);
        margin-top: 0;
        font-weight: 600;
    }

    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-actions button {
        padding: 10px 15px;
        font-size: 1em;
        border: 2px solid var(--theme-color);
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background-color: white;
        color: var(--theme-color);
        font-weight: 500;
    }

    .modal-actions button:last-child {
        background-color: #ccc;
        color: #333;
        border-color: #ccc;
    }

    .modal-actions button:hover:not(:last-child) {
        background-color: var(--theme-color);
        color: white;
    }
    .modal-actions button:last-child:hover {
        background-color: #bbb;
        border-color: #bbb;
    }
  </style>
</head>
<body>
  
  <div id="welcome-screen">
    <div class="left-pane">
        <h2>
            <span class="material-icons" style="font-size: 2em; color: var(--theme-color);">edit_document</span>
            æ–°è¦
        </h2>
        <button id="new-memo-button" onclick="startNewMemoFromHome()">
          <span class="material-icons">note_add</span>
          <span>ç©ºç™½ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</span>
        </button>
        <p style="text-align: center; color: #999; font-size: 0.9em; margin-top: 10px;">
            ãƒ¡ãƒ¢ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </p>
    </div>
    
    <div class="right-pane">
        <h2>
            <span class="material-icons">schedule</span>
            æœ€è¿‘ä½¿ç”¨ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
        </h2>
        <ul id="recent-memo-list" class="recent-list">
            </ul>
    </div>
  </div>

  <div id="document-view-container">
      
      <div class="top-bar-container">
        <button id="file-menu-button" class="file-button" onclick="toggleFileMenu()">ãƒ•ã‚¡ã‚¤ãƒ«</button>
        
        <div class="tab-bar">
            <button class="tab-button active" onclick="switchTab(this, 'home')">ãƒ›ãƒ¼ãƒ </button>
            <button class="tab-button" onclick="switchTab(this, 'insert')">æŒ¿å…¥</button>
            <button class="tab-button" onclick="switchTab(this, 'view')">è¡¨ç¤º</button>
            <button class="tab-button" onclick="switchTab(this, 'draw')">æç”»</button>
        </div>
      </div>

      <div class="ribbon-container">
        <div id="home-tab" class="tab-panel active">
            
            <div class="ribbon-group">
                <button onclick="document.execCommand('undo')" title="å…ƒã«æˆ»ã™ (Ctrl+Z)"><span class="material-icons">undo</span></button>
                <button onclick="document.execCommand('redo')" title="ã‚„ã‚Šç›´ã— (Ctrl+Y)"><span class="material-icons">redo</span></button>
                <span class="group-label">æ“ä½œ</span>
            </div>
            
            <div class="ribbon-group">
                <select id="font-selector" onchange="changeFontFamily(this.value)">
                    <option value="Arial" class="font-arial">Arial (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                    <option value="'Hachi Maru Pop', cursive" class="font-hachi-maru-pop">ã¯ã¡ã¾ã‚‹ãƒãƒƒãƒ—</option>
                    <option value="'Potta One', cursive" class="font-potta-one">ãƒãƒƒã‚¿ãƒ¯ãƒ³</option>
                    <option value="'Klee One', cursive" class="font-klee-one">ã‚¯ãƒ¬ãƒ¼ãƒ¯ãƒ³</option>
                    <option value="'Rampart One', cursive" class="font-rampart-one">ãƒ©ãƒ³ãƒ‘ãƒ¼ãƒˆãƒ¯ãƒ³</option>
                    <option value="'Mochiy Pop P One', sans-serif" class="font-mochiy-pop-p-one">ã‚‚ã¡ãƒãƒƒãƒ—Pãƒ¯ãƒ³</option>
                </select>
                
                <input type="number" id="font-size-input" min="1" max="90" value="16" title="ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º (pt)" onchange="changeFontSize(this.value)">
                
                <select onchange="changeColor(this.value)">
                    <option value="" selected disabled>è‰²</option>
                    <option value="black">é»’</option>
                    <option value="red">èµ¤</option>
                    <option value="blue">é’</option>
                    <option value="green">ç·‘</option>
                </select>
                
                <select id="highlight-selector" onchange="changeHighlightColor(this.value)" title="è›å…‰ãƒšãƒ³">
                    <option value="" selected disabled>ğŸ’¡</option>
                    <option value="rgba(255, 255, 0, 0.5)" style="background-color: rgba(255, 255, 0, 0.5);">é»„è‰² (åŠé€æ˜)</option>
                    <option value="rgba(0, 255, 0, 0.5)" style="background-color: rgba(0, 255, 0, 0.5);">ç·‘ (åŠé€æ˜)</option>
                    <option value="rgba(0, 255, 255, 0.5)" style="background-color: rgba(0, 255, 255, 0.5);">æ°´è‰² (åŠé€æ˜)</option>
                    <option value="rgba(255, 192, 203, 0.5)" style="background-color: rgba(255, 192, 203, 0.5);">ãƒ”ãƒ³ã‚¯ (åŠé€æ˜)</option>
                    <option value="transparent">ã‚¯ãƒªã‚¢</option>
                </select>
                
                <button id="bold-btn" onclick="toggleFormat(this, 'bold')"><span class="material-icons">format_bold</span></button>
                <button id="italic-btn" onclick="toggleFormat(this, 'italic')"><span class="material-icons">format_italic</span></button>
                <button id="underline-btn" onclick="toggleFormat(this, 'underline')"><span class="material-icons">format_underline</span></button>
                
                <span class="group-label">ãƒ•ã‚©ãƒ³ãƒˆã¨æ–‡å­—è£…é£¾</span>
            </div>

            <div class="ribbon-group">
                <button id="left-btn" onclick="toggleFormat(this, 'justifyLeft')"><span class="material-icons">format_align_left</span></button>
                <button id="center-btn" onclick="toggleFormat(this, 'justifyCenter')"><span class="material-icons">format_align_center</span></button>
                <button id="right-btn" onclick="toggleFormat(this, 'justifyRight')"><span class="material-icons">format_align_right</span></button>
                
                <button onclick="pasteAsPlainText(event)" title="æ›¸å¼ãªã—ã§è²¼ã‚Šä»˜ã‘ (Ctrl+Shift+Væ¨å¥¨)"><span class="material-icons">format_clear</span></button>

                <select onchange="changeLineHeight(this.value)">
                    <option value="" selected disabled>è¡Œé–“</option>
                    <option value="1.0">1.0</option>
                    <option value="1.5">1.5</option>
                    <option value="2.0">2.0</option>
                </select>
                <span class="group-label">æ®µè½</span>
            </div>
            <div class="ribbon-group">
  <button onclick="checkSpelling()">
    <span class="material-icons">spellcheck</span> ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯
  </button>
</div>

            <div class="ribbon-group">
                <button id="ul-btn" onclick="toggleFormat(this, 'insertUnorderedList')"><span class="material-icons">format_list_bulleted</span></button>
                <button id="ol-btn" onclick="toggleFormat(this, 'insertOrderedList')"><span class="material-icons">format_list_numbered</span></button>
                <span class="group-label">ãƒªã‚¹ãƒˆ</span>
            </div>

        </div>

        <div id="insert-tab" class="tab-panel" style="display:none;">
            <div class="ribbon-group">
                <button onclick="addTextBox()" title="è‡ªç”±ã«ç§»å‹•ã§ãã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ">
                    <span class="material-icons">text_fields</span>ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹
                </button>
                
                <button onclick="document.getElementById('file-input').click()" title="ç”»åƒã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŒ¿å…¥">
                    <span class="material-icons">add_photo_alternate</span>ç”»åƒ/ãƒ•ã‚¡ã‚¤ãƒ«
                </button>
                <input type="file" id="file-input" accept="image/*,.txt,.docx" onchange="handleFile(event)" style="display:none;">
                <span class="group-label">ãƒ¡ãƒ‡ã‚£ã‚¢</span>
            </div>
        </div>

        <div id="view-tab" class="tab-panel" style="display:none;">
            <div class="ribbon-group">
                <select onchange="changeTheme(this.value)">
                    <option value="blue">é’</option>
                    <option value="green">ç·‘</option>
                    <option value="orange">ã‚ªãƒ¬ãƒ³ã‚¸</option>
                    <option value="purple">ç´«</option>
                    <option value="gray">ã‚°ãƒ¬ãƒ¼</option>
                </select>
                <span class="group-label">ãƒ†ãƒ¼ãƒ</span>
            </div>
            <div class="ribbon-group">
                <button onclick="clearMemo()"><span class="material-icons">delete_sweep</span>ã‚¯ãƒªã‚¢</button>
                <span class="group-label">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</span>
            </div>
        </div>
        
        <div id="draw-tab" class="tab-panel" style="display:none;">
            <div class="ribbon-group">
                
                <button id="pen-tool-btn" onclick="activateDrawTool('pen')" title="ãƒšãƒ³"><span class="material-icons">draw</span></button>
                
                <button id="eraser-tool-btn" onclick="activateDrawTool('eraser')" title="æ¶ˆã—ã‚´ãƒ "><span class="material-icons">cleaning_services</span></button>
                
                <button id="ruler-tool-btn" onclick="activateDrawTool('ruler')" title="å®šè¦ï¼ˆç›´ç·šãƒ»45Â°ã‚¹ãƒŠãƒƒãƒ—ï¼‰"><span class="material-icons">square_foot</span></button>

                <span class="group-label">ãƒ„ãƒ¼ãƒ«</span>
            </div>
            
            <div class="ribbon-group">
                <select onchange="setDrawColor(this.value)" title="ãƒšãƒ³ã®è‰²">
                    <option value="" selected disabled>è‰²</option>
                    <option value="black" style="color: black;">é»’</option>
                    <option value="red" style="color: red;">èµ¤</option>
                    <option value="blue" style="color: blue;">é’</option>
                    <option value="green" style="color: green;">ç·‘</option>
                </select>
                
                <select onchange="setDrawThickness(this.value)" title="ç·šã®å¤ªã•">
                    <option value="" selected disabled>å¤ªã•</option>
                    <option value="2">ç´° (2px)</option>
                    <option value="5">ä¸­ (5px)</option>
                    <option value="10">å¤ª (10px)</option>
                </select>
                
                <span class="group-label">ãƒšãƒ³ã‚¹ã‚¿ã‚¤ãƒ«</span>
            </div>
        </div>
        </div>
      
      <div class="document">
        <div id="editor" contenteditable="true"></div>
        <canvas id="drawing-canvas"></canvas>
      </div>
  </div>


  <div id="file-menu-overlay" class="file-menu-overlay">
      <div class="menu-options-pane">
          
          <button class="menu-option" onclick="returnToHome(true)">
              <span class="material-icons">home</span>
              <span>ãƒ›ãƒ¼ãƒ ç”»é¢</span>
          </button>
          
          <hr style="border-color: #555; margin: 10px 0;">
          
          <button class="menu-option" onclick="showExportDialog()">
              <span class="material-icons">save_alt</span>
              <span>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
          </button>
          
          <button class="menu-option" onclick="printDocument()">
              <span class="material-icons">print</span>
              <span>å°åˆ· (PDFä¿å­˜)</span>
          </button>
          <hr style="border-color: #555; margin: 10px 0;">
          <button class="menu-option" onclick="toggleFileMenu()">
              <span class="material-icons">arrow_back</span>
              <span>ãƒªãƒœãƒ³ã«æˆ»ã‚‹</span>
          </button>
      </div>
      <div class="menu-detail-pane" onclick="toggleFileMenu()">
          <h2 style="color: white; padding: 20px;">[ãƒ•ã‚¡ã‚¤ãƒ«] ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
          <p style="color: #ccc; padding: 0 20px;">å°åˆ·ã‚„ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãªã©ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ“ä½œã¯ã“ã¡ã‚‰ã‹ã‚‰ã€‚</p>
      </div>
  </div>
  
  <div id="export-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ã®é¸æŠ</h2>
        <p>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã©ã®å½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="modal-actions">
            <button onclick="exportAsImage()">
                <span class="material-icons">image</span> PNG/JPEGç”»åƒå‡ºåŠ›
            </button>
            <button onclick="exportAsTxt()">
                <span class="material-icons">description</span> TXTå½¢å¼ (ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ)
            </button>
            <button onclick="exportAsDocx()">
                <span class="material-icons">article</span> DOCXå½¢å¼ (ãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆ)
            </button>
            <button onclick="closeModal('export-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
  </div>

  <div id="notification-modal" class="notification-modal">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
  
  <ul id="custom-context-menu">
      <li onclick="handlePinAction()"><span class="material-icons">push_pin</span><span id="pin-action-text">ãƒ”ãƒ³ç•™ã‚ã™ã‚‹</span></li>
      <li class="color-option">
          <span class="material-icons">border_color</span>æ ç·šã®è‰²
          <ul class="submenu">
            <li class="submenu-color-option" onclick="handleBorderColorAction('black')"><span class="color-swatch" style="background-color: black;"></span>é»’</li>
            <li class="submenu-color-option" onclick="handleBorderColorAction('red')"><span class="color-swatch" style="background-color: red;"></span>èµ¤</li>
            <li class="submenu-color-option" onclick="handleBorderColorAction('blue')"><span class="color-swatch" style="background-color: blue;"></span>é’</li>
            <li class="submenu-color-option" onclick="handleBorderColorAction('green')"><span class="color-swatch" style="background-color: green;"></span>ç·‘</li>
            <li class="submenu-color-option" onclick="handleBorderColorAction('transparent')"><span class="color-swatch" style="background-color: transparent; border: 1px dashed #ccc;"></span>é€æ˜</li>
          </ul>
      </li>
      <li onclick="deleteElement()"><span class="material-icons">delete</span>å‰Šé™¤</li>
  </ul>

  <script>
    const editor = document.getElementById('editor');
    const documentContainer = document.querySelector('.document'); 
    const contextMenu = document.getElementById('custom-context-menu'); 
    const MEMO_LIST_KEY = 'wordMemoList';
    const CURRENT_MEMO_ID_KEY = 'wordCurrentMemoId';
    
    let memos = []; 
    let currentMemoId = null; 
    let autoSaveInterval = null; 
    
    // ğŸ¨ æç”»æ©Ÿèƒ½é–¢é€£ã®å¤‰æ•° ğŸ¨
    const canvas = document.getElementById('drawing-canvas');
    const ctx = canvas.getContext('2d');
    let currentDrawTool = null;
    let currentDrawColor = 'black';
    let currentDrawThickness = 2; 
    let isDrawing = false; 
    let lastX = 0; 
    let lastY = 0; 
    let isRulerMode = false; 
    let startX = 0; 
    let startY = 0; 
    let savedCanvasImage = null; 

    // â­ ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½é–¢é€£ã®å¤‰æ•° â­
    let activeElement = null; 
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;
    let isDragging = false; 
    let contextTarget = null; // å³ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ 

    /**
     * UUIDã‚’ç”Ÿæˆã™ã‚‹
     * @returns {string} UUID
     */
    function generateUUID() {
      // ã‚·ãƒ³ãƒ—ãƒ«ãªUUIDç”Ÿæˆ 
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    /**
     * ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ (alertã®ä»£æ›¿)
     * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     */
    function showNotification(message) {
      const modal = document.getElementById('notification-modal');
      modal.innerText = message;
      modal.classList.add('show');
      setTimeout(() => {
        modal.classList.remove('show');
      }, 3000);
    }
    
    /**
     * ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     * @param {string} screenId - 'welcome' ã¾ãŸã¯ 'document'
     */
    function showScreen(screenId) {
        const welcomeScreen = document.getElementById('welcome-screen');
        const documentView = document.getElementById('document-view-container');
        
        // è‡ªå‹•ä¿å­˜ã‚’åˆ¶å¾¡
        if (screenId === 'document') {
            documentView.style.display = 'flex';
            welcomeScreen.style.display = 'none';
            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã«å…¥ã£ãŸã‚‰è‡ªå‹•ä¿å­˜ã‚’é–‹å§‹
            if (!autoSaveInterval) {
                autoSaveInterval = setInterval(saveCurrentMemo, 5000); 
            }
            // æ–°è¦è¿½åŠ : ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ“ãƒ¥ãƒ¼ã«å…¥ã£ãŸã‚‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒªã‚µã‚¤ã‚º
            setTimeout(resizeCanvas, 50); 
        } else {
            welcomeScreen.style.display = 'flex';
            documentView.style.display = 'none';
            // ãƒ›ãƒ¼ãƒ ç”»é¢ã«å…¥ã£ãŸã‚‰è‡ªå‹•ä¿å­˜ã‚’åœæ­¢
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            // ãƒ›ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºæ™‚ã¯ãƒªã‚¹ãƒˆã‚’å†æç”»
            renderRecentMemoList();
        }
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡æ©Ÿèƒ½ ---
    
    /**
     * æŒ‡å®šã•ã‚ŒãŸIDã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {string} modalId - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®DOM ID
     */
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸIDã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
     * @param {string} modalId - ãƒ¢ãƒ¼ãƒ€ãƒ«ã®DOM ID
     */
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // --- ãƒ¡ãƒ¢ç®¡ç†æ©Ÿèƒ½ ---
    
    /**
     * ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆã‚’Local Storageã‹ã‚‰èª­ã¿è¾¼ã‚€
     */
    function loadMemosFromStorage() {
      const savedMemos = localStorage.getItem(MEMO_LIST_KEY);
      memos = savedMemos ? JSON.parse(savedMemos) : [];
      
      // ã‚½ãƒ¼ãƒˆ: æœ€çµ‚æ›´æ–°æ—¥æ™‚ãŒæ–°ã—ã„é †
      memos.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
      
      const savedId = localStorage.getItem(CURRENT_MEMO_ID_KEY);
      currentMemoId = savedId;
      
      // èµ·å‹•æ™‚ã¯å¿…ãšãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
      showScreen('welcome'); 
    }

    /**
     * ç¾åœ¨ã®ãƒ¡ãƒ¢ã®å†…å®¹ã‚’memosé…åˆ—ã¨Local Storageã«ä¿å­˜ã™ã‚‹
     */
    function saveCurrentMemo() {
        if (document.getElementById('document-view-container').style.display === 'none') return;
        
        // Canvasã®å†…å®¹ã‚’ç”»åƒåŒ–
        const canvasContent = isCanvasEmpty() ? '' : canvas.toDataURL('image/png');
        
        // draggable-element (ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã¨ç”»åƒ) ã®å†…å®¹ã‚’ä¿å­˜
        const draggableElementsData = [];
        documentContainer.querySelectorAll('.draggable-element').forEach(el => {
             const isTextBox = el.classList.contains('draggable-textbox');
             const data = {
                 id: el.getAttribute('data-id') || generateUUID(),
                 type: isTextBox ? 'textbox' : 'image',
                 html: isTextBox ? el.innerHTML : '',
                 src: !isTextBox ? el.querySelector('img').src : '',
                 left: el.style.left,
                 top: el.style.top,
                 width: el.style.width,
                 height: el.style.height,
                 pinned: el.classList.contains('pinned'),
                 // â­ æ–°è¦è¿½åŠ : æ ç·šè‰²ã‚’ä¿å­˜ â­
                 borderColor: el.style.borderColor || '' 
             };
             el.setAttribute('data-id', data.id); // IDã‚’è¦ç´ ã«ç¢ºå®šã•ã›ã‚‹
             draggableElementsData.push(data);
        });

        // ã‚¨ãƒ‡ã‚£ã‚¿ã®HTMLã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
        const content = editor.innerHTML;
        const fullContent = {
             html: content,
             draw: canvasContent,
             draggable: draggableElementsData 
        };
        
        // å†…å®¹ãŒå®Œå…¨ã«ç©º (ä½•ã‚‚å…¥åŠ›ã•ã‚Œã¦ã„ãªã„) ã®å ´åˆã¯ä¿å­˜ã—ãªã„
        if (!content && !canvasContent && draggableElementsData.length === 0) {
            return;
        }
        
        // æœ€åˆã®æ•°æ–‡å­—ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦æŠ½å‡º
        let title = content.replace(/<[^>]*>/g, '').substring(0, 30).trim();
        if (title.length === 0 && draggableElementsData.length > 0) {
            title = draggableElementsData.length > 1 ? `ãƒ¡ãƒ¢ (${draggableElementsData.length}è¦ç´ )` : `ãƒ¡ãƒ¢ (${draggableElementsData[0].type})`;
        } else if (title.length === 0) {
             title = 'ç„¡é¡Œã®ãƒ¡ãƒ¢';
        }
        
        const now = new Date().toISOString();

        const newMemoData = {
            id: currentMemoId || generateUUID(),
            title: title,
            content: fullContent, // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
            lastUpdated: now
        };
        
        currentMemoId = newMemoData.id; // IDã‚’ç¢ºå®š

        const index = memos.findIndex(m => m.id === currentMemoId);
        if (index > -1) {
            memos[index] = newMemoData; // æ›´æ–°
        } else {
            memos.unshift(newMemoData); // æ–°è¦è¿½åŠ ï¼ˆä¸€ç•ªä¸Šã«è¿½åŠ ï¼‰
        }

        // ãƒªã‚¹ãƒˆã‚’æ›´æ–°æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆã—ç›´ã™
        memos.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));

        // Local Storageã‚’æ›´æ–°
        localStorage.setItem(MEMO_LIST_KEY, JSON.stringify(memos));
        localStorage.setItem(CURRENT_MEMO_ID_KEY, currentMemoId);
    }
    
    /**
     * é¸æŠã—ãŸãƒ¡ãƒ¢ã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«èª­ã¿è¾¼ã‚€
     * @param {string} id - èª­ã¿è¾¼ã‚€ãƒ¡ãƒ¢ã®ID
     */
    function loadMemo(id) {
        saveCurrentMemo(); // é–‹ãå‰ã«ç¾åœ¨ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜
        const memoToLoad = memos.find(m => m.id === id);
        if (memoToLoad) {
            // ã‚¨ãƒ‡ã‚£ã‚¿HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            editor.innerHTML = memoToLoad.content.html || memoToLoad.content; // æ—§å½¢å¼ã«ã‚‚å¯¾å¿œ
            
            // æ—¢å­˜ã®draggable-elementã‚’ã‚¯ãƒªã‚¢
            documentContainer.querySelectorAll('.draggable-element').forEach(el => el.remove());

            // æç”»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å¾©å…ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const drawData = memoToLoad.content.draw;
            if (drawData) {
                 const img = new Image();
                 img.onload = function() {
                      // æç”»å†…å®¹ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åæ˜ 
                      ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
                 };
                 img.src = drawData;
            }
            
            // Draggable Elementã‚’å¾©å…ƒ
            const draggableData = memoToLoad.content.draggable || [];
            draggableData.forEach(data => {
                let el;
                if (data.type === 'textbox') {
                    el = createTextBoxElement(data);
                    el.innerHTML = data.html;
                } else if (data.type === 'image') {
                    el = createImageElement(data);
                }
                
                if (el) {
                    el.style.left = data.left;
                    el.style.top = data.top;
                    el.style.width = data.width;
                    el.style.height = data.height;
                    el.style.borderColor = data.borderColor; // â­ æ ç·šè‰²ã‚’å¾©å…ƒ â­
                    el.setAttribute('data-id', data.id);
                    if (data.pinned) {
                        el.classList.add('pinned');
                        el.style.cursor = 'default';
                    }
                    documentContainer.appendChild(el);
                }
            });

            currentMemoId = id;
            localStorage.setItem(CURRENT_MEMO_ID_KEY, currentMemoId);
            showScreen('document'); // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
            showNotification(`ã€Œ${memoToLoad.title}ã€ã‚’é–‹ãã¾ã—ãŸ`);
            // é–‹ã„ãŸãƒ¡ãƒ¢ã®å†…å®¹ã«åŸºã¥ã„ã¦ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            setTimeout(updateButtonStates, 100); 
            
            // æç”»ãƒ„ãƒ¼ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentDrawTool = null;
            document.querySelectorAll('#draw-tab button').forEach(btn => btn.classList.remove('active'));
            canvas.style.pointerEvents = 'none'; // ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ã«æˆ»ã™
            ctx.globalCompositeOperation = 'source-over'; 
        }
    }
    
    /**
     * ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹è¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
     */
    function createTextBoxElement(data) {
        const box = document.createElement('div');
        box.className = 'draggable-element draggable-textbox';
        box.setAttribute('contenteditable', 'true');
        box.textContent = data && data.html ? '' : 'è‡ªç”±ã«ç§»å‹•ã§ãã‚‹ãƒ†ã‚­ã‚¹ãƒˆ';
        box.oncontextmenu = (e) => showContextMenu(e, box);
        return box;
    }
    
    /**
     * ç”»åƒè¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
     */
    function createImageElement(data) {
        const wrapper = document.createElement('div');
        wrapper.className = 'draggable-element';
        // åˆæœŸã‚µã‚¤ã‚ºã‚’è¨­å®š (ãƒªã‚µã‚¤ã‚ºå¯èƒ½)
        wrapper.style.width = data && data.width ? data.width : '200px'; 
        wrapper.style.height = data && data.height ? data.height : '150px'; 
        
        const img = document.createElement('img');
        img.src = data.src;
        wrapper.appendChild(img);
        wrapper.oncontextmenu = (e) => showContextMenu(e, wrapper);
        return wrapper;
    }
    
    // --- æ—¢å­˜ã®æ©Ÿèƒ½ã®ç¶­æŒã¨ä¿®æ­£ ---
    
    // handleFileã®ç”»åƒã‚’editorã§ã¯ãªãdocumentContainerã«è¿½åŠ ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // ç”»åƒã‚’draggable-elementã¨ã—ã¦documentContainerç›´ä¸‹ã«è¿½åŠ 
          const wrapper = createImageElement({ src: e.target.result });
          
          // åˆæœŸä½ç½®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®šï¼ˆé‡ãªã‚Šã‚’é˜²ããŸã‚ï¼‰
          const docRect = documentContainer.getBoundingClientRect();
          wrapper.style.left = (Math.random() * (docRect.width - 250) + 20) + 'px';
          wrapper.style.top = (Math.random() * (docRect.height - 250) + 20) + 'px';
          
          documentContainer.appendChild(wrapper);
          showNotification('ğŸ–¼ï¸ è‡ªç”±ã«ãƒ‰ãƒ©ãƒƒã‚°ã§ãã‚‹ç”»åƒã‚’æŒ¿å…¥ã—ã¾ã—ãŸ');
        };
        reader.readAsDataURL(file);
      } else if (file.name.endsWith('.txt')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          editor.innerText += '\n' + e.target.result;
          showNotification('.txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ');
        };
        reader.readAsText(file);
      } else if (file.name.endsWith('.docx')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const arrayBuffer = e.target.result;
          mammoth.convertToHtml({ arrayBuffer: arrayBuffer })
            .then(result => {
              editor.innerHTML += result.value;
              showNotification('.docxãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ');
            })
            .catch(err => {
              showNotification('Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
              console.error(err);
            });
        };
        reader.readAsArrayBuffer(file);
      } else {
        showNotification('å¯¾å¿œã—ã¦ã„ã‚‹ã®ã¯ç”»åƒã€.txtã€.docx ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
      }
      event.target.value = '';
    }

    // --- â­ Draggable Element Logic â­ ---
    
    // ãƒ‰ãƒ©ãƒƒã‚°ã‚’åˆæœŸåŒ–ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼ (documentContainerå…¨ä½“ã«è¿½åŠ )
    documentContainer.addEventListener('mousedown', dragStart);
    documentContainer.addEventListener('mouseup', dragEnd);
    documentContainer.addEventListener('mousemove', drag);
    documentContainer.addEventListener('mouseleave', dragEnd); // ã‚³ãƒ³ãƒ†ãƒŠå¤–ã«å‡ºãŸæ™‚ã‚‚çµ‚äº†

    /**
     * ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
     */
    function dragStart(e) {
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰é–‰ã˜ã‚‹
        contextMenu.style.display = 'none';

        // ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ã¯ .draggable-element ã‚¯ãƒ©ã‚¹ã‚’æŒã¤è¦ç´ ã«é™å®š
        // ãŸã ã—ã€ãƒ”ãƒ³ç•™ã‚ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã®ã¿
        let targetElement = e.target.closest('.draggable-element');
        
        if (targetElement && !targetElement.classList.contains('pinned')) {
            
            // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
            const style = window.getComputedStyle(targetElement);
            // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®åº§æ¨™ã‚’å³å¯†ã«åˆ¤å®šã™ã‚‹ã®ã¯å›°é›£ãªãŸã‚ã€ã“ã“ã§ã¯ç°¡æ˜“çš„ãªãƒ­ã‚¸ãƒƒã‚¯ã§å¯¾å¿œ
            const rect = targetElement.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            // å³ä¸‹éš…ä»˜è¿‘ï¼ˆãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«é ˜åŸŸï¼‰ã§ã‚ã‚Œã°ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
            const resizeHandleSize = 20; 
            if (clickX > rect.width - resizeHandleSize && clickY > rect.height - resizeHandleSize) {
                 return; 
            }
            
            // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹å†…ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠãƒ»ç·¨é›†ã‚’å¦¨ã’ãªã„ãŸã‚ã®ãƒã‚§ãƒƒã‚¯
            const isTextBox = targetElement.classList.contains('draggable-textbox');
            let shouldStartDrag = true;
            
            if (isTextBox) {
                // e.targetãŒãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°é ˜åŸŸï¼ˆç«¯ï¼‰ãªã‚‰ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                // ç°¡æ˜“çš„ãªãƒ‘ãƒ‡ã‚£ãƒ³ã‚°é ˜åŸŸãƒã‚§ãƒƒã‚¯ (ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®8pxå¤–å´ã‚’ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã¨è¦‹ãªã™)
                if (clickX > 8 && clickX < rect.width - 8 && clickY > 8 && clickY < rect.height - 8) {
                    // ãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸå†…ã®ã‚¯ãƒªãƒƒã‚¯ã¨è¦‹ãªã™
                    shouldStartDrag = false;
                }
            }

            if (shouldStartDrag) {
                e.preventDefault();
                activeElement = targetElement;
                isDragging = true;
                
                // documentContainerã‹ã‚‰ã®ç›¸å¯¾åº§æ¨™ã‚’å–å¾—
                const rect = documentContainer.getBoundingClientRect();
                const elRect = activeElement.getBoundingClientRect();
                
                // ãƒã‚¦ã‚¹ä½ç½®ã‹ã‚‰è¦ç´ ã®å·¦ä¸Šç«¯ã¾ã§ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—
                xOffset = e.clientX - elRect.left;
                yOffset = e.clientY - elRect.top;
                
                activeElement.style.cursor = 'grabbing';
            }
        }
    }

    /**
     * ãƒ‰ãƒ©ãƒƒã‚°ä¸­
     */
    function drag(e) {
        if (!isDragging || !activeElement) return;
        
        // documentContainerã‹ã‚‰ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—
        const rect = documentContainer.getBoundingClientRect();
        let newLeft = e.clientX - rect.left - xOffset;
        let newTop = e.clientY - rect.top - yOffset;
        
        // å¢ƒç•Œãƒã‚§ãƒƒã‚¯ (ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«)
        const activeRect = activeElement.getBoundingClientRect();
        
        // å·¦ç«¯ã®ã‚¯ãƒªãƒƒãƒ—
        if (newLeft < 0) newLeft = 0;
        // ä¸Šç«¯ã®ã‚¯ãƒªãƒƒãƒ—
        if (newTop < 0) newTop = 0;
        // å³ç«¯ã®ã‚¯ãƒªãƒƒãƒ— (è¦ç´ ã®å¹…ã‚‚è€ƒæ…®)
        // æ³¨æ„: activeRect.width ã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚µã‚¤ã‚ºå¤‰åŒ–ã‚’åæ˜ ã—ãªã„å ´åˆãŒã‚ã‚‹ãŒã€ã“ã“ã§ã¯ç°¡æ˜“åŒ–
        if (newLeft + activeElement.offsetWidth > rect.width) newLeft = rect.width - activeElement.offsetWidth;
        // ä¸‹ç«¯ã®ã‚¯ãƒªãƒƒãƒ— (è¦ç´ ã®é«˜ã•ã‚‚è€ƒæ…®)
        if (newTop + activeElement.offsetHeight > rect.height) newTop = rect.height - activeElement.offsetHeight;
        
        activeElement.style.left = newLeft + 'px';
        activeElement.style.top = newTop + 'px';
    }

    /**
     * ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
     */
    function dragEnd(e) {
        if (isDragging) {
            isDragging = false;
            if (activeElement) {
                activeElement.style.cursor = activeElement.classList.contains('pinned') ? 'default' : 'grab';
                activeElement = null;
                saveCurrentMemo(); // ãƒ‰ãƒ©ãƒƒã‚°ãŒçµ‚äº†ã—ãŸã‚‰ä¿å­˜
            }
        }
    }
    
    /**
     * ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã™ã‚‹
     */
    function addTextBox() {
        // æç”»ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        if (currentDrawTool) {
            switchTab(document.querySelector('.tab-button[onclick*="\'home\'"]'), 'home');
        }
        
        const box = createTextBoxElement();
        
        // åˆæœŸä½ç½®ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸­å¤®ã«è¨­å®š
        const docRect = documentContainer.getBoundingClientRect();
        box.style.width = '150px';
        box.style.height = '50px';
        box.style.left = (docRect.width / 2 - 75) + 'px'; 
        box.style.top = (docRect.height / 2 - 25) + 'px';
        
        documentContainer.appendChild(box);
        box.focus();
        showNotification('ğŸ”  è‡ªç”±ã«ãƒ‰ãƒ©ãƒƒã‚°ã§ãã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }

    // --- â­ Context Menu Logic â­ ---
    
    // documentã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
        if (!contextMenu.contains(e.target)) {
            contextMenu.style.display = 'none';
            contextTarget = null;
        }
    });
    
    // documentã®å³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆè¦ç´ ãŒæ•ã¾ãˆãªã‹ã£ãŸå ´åˆï¼‰
    document.addEventListener('contextmenu', (e) => {
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼è‡ªä½“ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯é–‰ã˜ãªã„
        if (contextMenu.style.display !== 'none' && !e.target.closest('#custom-context-menu')) {
            contextMenu.style.display = 'none';
        }
    });


    /**
     * ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
     * @param {Event} e - event
     * @param {HTMLElement} target - å³ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸ draggable-element
     */
    function showContextMenu(e, target) {
        e.preventDefault();
        e.stopPropagation(); // documentã®contextmenuã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹ã®ã‚’é˜²ã
        
        contextTarget = target;
        
        // ãƒ”ãƒ³ç•™ã‚çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        const isPinned = target.classList.contains('pinned');
        document.getElementById('pin-action-text').textContent = isPinned ? 'ãƒ”ãƒ³ç•™ã‚ã‚’è§£é™¤' : 'ãƒ”ãƒ³ç•™ã‚ã™ã‚‹';

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½ç½®ã‚’è¨­å®š
        contextMenu.style.left = e.clientX + 'px';
        contextMenu.style.top = e.clientY + 'px';
        contextMenu.style.display = 'block';
    }

    /**
     * ãƒ”ãƒ³ç•™ã‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
     */
    function handlePinAction() {
        if (!contextTarget) return;

        const isPinned = contextTarget.classList.toggle('pinned');
        contextTarget.style.cursor = isPinned ? 'default' : 'grab'; // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æ›´æ–°
        
        showNotification(isPinned ? 'ğŸ“Œ è¦ç´ ã‚’ãƒ”ãƒ³ç•™ã‚ã—ã¾ã—ãŸ' : 'è¦ç´ ã®ãƒ”ãƒ³ç•™ã‚ã‚’è§£é™¤ã—ã¾ã—ãŸ');
        contextMenu.style.display = 'none';
        contextTarget = null;
        saveCurrentMemo(); // çŠ¶æ…‹å¤‰æ›´ã‚’ä¿å­˜
    }
    
    /**
     * â­ æ–°è¦è¿½åŠ : æ ç·šã®è‰²ã‚’å¤‰æ›´ã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ â­
     * @param {string} color - é©ç”¨ã™ã‚‹CSSã‚«ãƒ©ãƒ¼å€¤ ('red', 'black', 'transparent'ãªã©)
     */
    function handleBorderColorAction(color) {
        if (!contextTarget) return;

        contextTarget.style.borderStyle = 'solid'; // å¿…ãšå®Ÿç·šã«ã™ã‚‹
        if (color === 'transparent') {
            contextTarget.style.borderColor = color;
            contextTarget.style.borderWidth = '1px'; // é€æ˜ã§ã‚‚å¹…ã‚’ç¶­æŒ
            showNotification('æ ç·šã‚’é€æ˜ã«ã—ã¾ã—ãŸ');
        } else {
            contextTarget.style.borderColor = color;
            contextTarget.style.borderWidth = '1px';
            showNotification(`æ ç·šã‚’${color}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        }

        contextMenu.style.display = 'none';
        contextTarget = null;
        saveCurrentMemo(); // çŠ¶æ…‹å¤‰æ›´ã‚’ä¿å­˜
    }


    /**
     * è¦ç´ ã‚’å‰Šé™¤
     */
    function deleteElement() {
        if (contextTarget) {
            contextTarget.remove();
            showNotification('è¦ç´ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            contextMenu.style.display = 'none';
            contextTarget = null;
            saveCurrentMemo(); // çŠ¶æ…‹å¤‰æ›´ã‚’ä¿å­˜
        }
    }
    
    // --- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã®æ®‹ã‚Šã®éƒ¨åˆ† (ãƒ¡ãƒ¢ç®¡ç†ãªã©) ---
    
    function startNewMemoFromHome() { newMemo(true); }
    function deleteMemo(id) { /* ... */ }
    function renderRecentMemoList() { 
        const listElement = document.getElementById('recent-memo-list');
        listElement.innerHTML = ''; 

        if (memos.length === 0) {
            listElement.innerHTML = '<li style="padding: 15px; color: #777;">ã¾ã ä¿å­˜ã•ã‚ŒãŸãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
            return;
        }

        memos.forEach(memo => {
            const li = document.createElement('li');
            li.className = 'recent-item';
            
            const icon = document.createElement('span');
            icon.className = 'material-icons';
            icon.textContent = 'description'; 

            const infoDiv = document.createElement('div');
            infoDiv.className = 'recent-info';
            infoDiv.onclick = () => loadMemo(memo.id); 
            
            const titleSpan = document.createElement('div');
            titleSpan.className = 'recent-title';
            titleSpan.textContent = memo.title;
            
            const dateSpan = document.createElement('div');
            dateSpan.className = 'recent-date';
            dateSpan.textContent = new Date(memo.lastUpdated).toLocaleString('ja-JP');
            
            infoDiv.appendChild(titleSpan);
            infoDiv.appendChild(dateSpan);
            
            const deleteButton = document.createElement('button');
            deleteButton.className = 'recent-delete';
            deleteButton.innerHTML = '<span class="material-icons" style="font-size: 18px;">delete</span>';
            deleteButton.title = 'å‰Šé™¤';
            deleteButton.onclick = (e) => {
                e.stopPropagation(); 
                deleteMemo(memo.id);
            };

            li.appendChild(icon);
            li.appendChild(infoDiv);
            li.appendChild(deleteButton);
            listElement.appendChild(li);
        });
    }

    function getMemoFileName() {
        const content = editor.innerHTML;
        let title = content.replace(/<[^>]*>/g, '').substring(0, 30).trim();
        if (title.length === 0) {
            title = 'ç„¡é¡Œã®ãƒ¡ãƒ¢';
        }
        return title.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s]/g, '').trim() || 'document';
    }

    function showExportDialog() {
        toggleFileMenu(); 
        saveCurrentMemo();
        openModal('export-modal');
    }

    function downloadFile(filename, content, type) {
        const blob = new Blob([content], { type: type });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }

    function exportAsTxt() {
        closeModal('export-modal');
        const filename = getMemoFileName() + '.txt';
        const content = editor.innerText; 
        downloadFile(filename, content, 'text/plain');
        showNotification(`ã€Œ${filename}ã€ã‚’TXTå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
    }

    function exportAsDocx() {
        closeModal('export-modal');
        const filename = getMemoFileName() + '.docx';
        
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>${getMemoFileName()}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; padding: 20px; }
                </style>
            </head>
            <body>
                ${editor.innerHTML}
            </body>
            </html>
        `;
        
        downloadFile(filename, htmlContent, 'application/msword');
        showNotification(`ã€Œ${filename}ã€ã‚’DOCXå½¢å¼ï¼ˆãƒªãƒƒãƒãƒ†ã‚­ã‚¹ãƒˆï¼‰ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
    }
    
    /**
     * â­ æ–°è¦è¿½åŠ : ç”»åƒå‡ºåŠ›æ©Ÿèƒ½ (ãƒ”ãƒ³ç•™ã‚/ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«éè¡¨ç¤º) â­
     */
    function exportAsImage() {
        closeModal('export-modal');
        saveCurrentMemo(); 

        // 1. ç”»åƒå‡ºåŠ›ç”¨ã®CSSã‚¯ãƒ©ã‚¹ã‚’ä¸€æ™‚çš„ã«é©ç”¨
        documentContainer.classList.add('export-mode');

        showNotification('ğŸ“¸ ç”»åƒå‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰: èµ¤ã„æ ç·šã¨ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚„OSã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ãã ã•ã„ï¼');
        
        // 2. 5ç§’å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¦å…ƒã«æˆ»ã™
        setTimeout(() => {
            documentContainer.classList.remove('export-mode');
            showNotification('ç”»åƒå‡ºåŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚');
        }, 5000); 
    }


    function isCanvasEmpty() {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€å®Œå…¨ã«é€æ˜ã‹ã©ã†ã‹ã‚’åˆ¤æ–­
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        for (let i = 0; i < data.length; i += 4) {
            // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ãŒ0ã‚ˆã‚Šå¤§ãã‘ã‚Œã°æç”»ã•ã‚Œã¦ã„ã‚‹
            if (data[i + 3] > 0) return false; 
        }
        return true;
    }

    function toggleFileMenu() {
        const overlay = document.getElementById('file-menu-overlay');
        const fileButton = document.getElementById('file-menu-button');
        const isOpen = overlay.classList.contains('open');

        if (!isOpen) {
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.classList.add('open');
                fileButton.classList.add('active');
            }, 10);
        } else {
            overlay.classList.remove('open');
            fileButton.classList.remove('active');

            setTimeout(() => {
                if (!overlay.classList.contains('open')) {
                    overlay.style.display = 'none';
                }
            }, 300); 
        }
    }

    function returnToHome(fromMenu = false) {
        saveCurrentMemo(); 
        if(fromMenu) {
            toggleFileMenu(); 
        }
        showScreen('welcome'); 
        showNotification('ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã—ãŸ');
    }

    function printDocument() {
        toggleFileMenu(); 
        saveCurrentMemo(); 
        window.print();
        showNotification('ãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰PDFã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚');
    }

    function switchTab(activeTabButton, tabName) { 
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        activeTabButton.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(panel => panel.style.display = 'none');
        document.getElementById(`${tabName}-tab`).style.display = 'flex';
        
        if (tabName === 'draw') {
             canvas.style.pointerEvents = 'auto'; 
             if (!currentDrawTool) {
                 activateDrawTool('pen'); 
             } else {
                 document.getElementById(`${currentDrawTool}-tool-btn`)?.classList.add('active');
                 showNotification('æç”»ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ãŸã€‚');
             }
        } else {
             canvas.style.pointerEvents = 'none'; 
             document.querySelectorAll('#draw-tab button').forEach(btn => btn.classList.remove('active'));
             ctx.globalCompositeOperation = 'source-over';
        }
        
        updateButtonStates();
    }
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
    window.onload = () => {
      loadMemosFromStorage(); 
      const activeTab = document.querySelector('.tab-button.active');
      if(activeTab) activeTab.click();
      updateButtonStates();
      resizeCanvas(); 
    };

    function clearMemo() {
      if (confirm('ç¾åœ¨ã®ãƒ¡ãƒ¢ã®å†…å®¹ã‚’æœ¬å½“ã«ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ¡ãƒ¢ã¯ãƒªã‚¹ãƒˆã«æ®‹ã‚Šã¾ã™ï¼‰')) {
          editor.innerHTML = '';
          document.getElementById('font-size-input').value = '16';
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          documentContainer.querySelectorAll('.draggable-element').forEach(el => el.remove());
          showNotification('ç¾åœ¨ã®ãƒ¡ãƒ¢ã®å†…å®¹ã¨æç”»å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }
    }
    
    function changeFontFamily(fontFamily) { 
        if (!fontFamily) return;
        try {
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('fontName', false, fontFamily);
            document.execCommand('styleWithCSS', false, false);
            showNotification(`${fontFamily}ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
        } catch (e) {
            showNotification('ãƒ•ã‚©ãƒ³ãƒˆã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é¸æŠç¯„å›²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    }
    
    function changeFontSize(size) {
        const pt = parseInt(size);
        if (pt >= 1 && pt <= 90) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.fontSize = pt + 'pt';
                span.style.lineHeight = 'normal'; 
                
                try {
                    range.surroundContents(span);
                    showNotification(`${pt}ptã‚’é©ç”¨ã—ã¾ã—ãŸ`);
                } catch (e) {
                    showNotification('ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å˜ä¸€ã®æ®µè½ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                }
            } else {
                 showNotification('æ–‡å­—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            }
        }
    }
    
    function changeHighlightColor(color) {
        if (!color) return;
        if (color === 'transparent') {
             document.execCommand('hiliteColor', false, 'white');
             showNotification('è›å…‰ãƒšãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        } else {
             document.execCommand('hiliteColor', false, color);
             showNotification(`è›å…‰ãƒšãƒ³ã‚’${color}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        }
        document.getElementById('highlight-selector').value = '';
    }
    
    function pasteAsPlainText(event) {
        showNotification('è²¼ã‚Šä»˜ã‘ãŸã„å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸå¾Œã€ã‚¨ãƒ‡ã‚£ã‚¿å†…ã§ **Ctrl+Shift+V** (Mac: **Cmd+Shift+V**) ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
    }

    function changeColor(color) {
      if (color) document.execCommand('foreColor', false, color);
      document.querySelector('.ribbon-group select:nth-of-type(2)').value = ''; 
    }
    
    function changeLineHeight(height) {
      if (height) {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const blockParent = range.commonAncestorContainer.parentElement.closest('div, p, li');
          
          if (blockParent && blockParent.id !== 'editor') {
              blockParent.style.lineHeight = height;
          } else {
              const span = document.createElement('span');
              span.style.lineHeight = height;
              try {
                 range.surroundContents(span);
              } catch(e) {
                 showNotification('è¡Œé–“ã®å¤‰æ›´ã¯ã€å˜ä¸€ã®æ®µè½ã‚’é¸æŠã—ã¦ãã ã•ã„');
              }
          }
        }
      }
      document.querySelector('.ribbon-group select:nth-of-type(3)').value = ''; 
    }
    
    function changeTheme(theme) {
      const root = document.documentElement;
      let color, hoverColor;
      switch (theme) {
        case 'blue': color = '#0078d4'; hoverColor = '#005a9e'; break;
        case 'green': color = '#4caf50'; hoverColor = '#388e3c'; break;
        case 'orange': color = '#ff9800'; hoverColor = '#f57c00'; break;
        case 'purple': color = '#9c27b0'; hoverColor = '#7b1fa2'; break;
        case 'gray': color = '#607d8b'; hoverColor = '#455a64'; break;
      }
      root.style.setProperty('--theme-color', color);
      root.style.setProperty('--theme-hover', hoverColor);
      showNotification(`ãƒ†ãƒ¼ãƒã‚’${theme}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
    }

    function toggleFormat(button, command) {
        document.execCommand(command, false, null);
        button.classList.toggle('active', document.queryCommandState(command)); 
    }

    function updateButtonStates() {
        document.getElementById('bold-btn')?.classList.toggle('active', document.queryCommandState('bold'));
        document.getElementById('italic-btn')?.classList.toggle('active', document.queryCommandState('italic'));
        document.getElementById('underline-btn')?.classList.toggle('active', document.queryCommandState('underline'));
        
        document.getElementById('ul-btn')?.classList.toggle('active', document.queryCommandState('insertUnorderedList'));
        document.getElementById('ol-btn')?.classList.toggle('active', document.queryCommandState('insertOrderedList'));
        
        document.getElementById('left-btn')?.classList.toggle('active', document.queryCommandState('justifyLeft'));
        document.getElementById('center-btn')?.classList.toggle('active', document.queryCommandState('justifyCenter'));
        document.getElementById('right-btn')?.classList.toggle('active', document.queryCommandState('justifyRight'));
    }

    editor.addEventListener('mouseup', updateButtonStates); 
    editor.addEventListener('keyup', updateButtonStates);  
    
    // --- ğŸ¨ æç”»ãƒ„ãƒ¼ãƒ«ã®æ©Ÿèƒ½ (ãƒšãƒ³ã€æ¶ˆã—ã‚´ãƒ ã€å®šè¦) ---
    
    function resizeCanvas() {
        const editorRect = editor.getBoundingClientRect();
        canvas.width = editorRect.width;
        canvas.height = editorRect.height;
        canvas.style.top = `${editor.offsetTop}px`;
        canvas.style.left = `${editor.offsetLeft}px`;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        
        // å†æç”»
        const currentMemo = memos.find(m => m.id === currentMemoId);
        if (currentMemo && currentMemo.content.draw) {
             const img = new Image();
             img.onload = function() {
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height); 
             };
             img.src = currentMemo.content.draw;
        }
    }
    window.addEventListener('resize', resizeCanvas);
    
    function getSnappedCoordinates(startX, startY, endX, endY) {
        const dx = endX - startX;
        const dy = endY - startY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx); // ãƒ©ã‚¸ã‚¢ãƒ³
        const angleDeg = angle * 180 / Math.PI;

        let snappedAngle = angle;
        
        // 45åº¦ã‚¹ãƒŠãƒƒãƒ—
        const snapIncrement = 45;
        const snappedDeg = Math.round(angleDeg / snapIncrement) * snapIncrement;
        snappedAngle = snappedDeg * Math.PI / 180;

        return {
            x: startX + dist * Math.cos(snappedAngle),
            y: startY + dist * Math.sin(snappedAngle)
        };
    }
    
    function activateDrawTool(toolName) {
        currentDrawTool = toolName;
        document.querySelectorAll('#draw-tab button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${toolName}-tool-btn`).classList.add('active');
        
        isRulerMode = (toolName === 'ruler');
        if (toolName === 'eraser') {
            ctx.globalCompositeOperation = 'destination-out'; // æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰
            canvas.style.cursor = 'crosshair';
        } else {
            ctx.globalCompositeOperation = 'source-over'; // ãƒšãƒ³ãƒ¢ãƒ¼ãƒ‰
            canvas.style.cursor = isRulerMode ? 'crosshair' : 'crosshair';
        }
        showNotification(`${toolName === 'eraser' ? 'æ¶ˆã—ã‚´ãƒ ' : isRulerMode ? 'å®šè¦' : 'ãƒšãƒ³'} ãƒ„ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ`);
    }

    function startDrawing(e) {
        if (!currentDrawTool) return;
        isDrawing = true;
        
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;

        if (isRulerMode) {
             startX = lastX;
             startY = lastY;
             // å®šè¦ãƒ¢ãƒ¼ãƒ‰é–‹å§‹æ™‚ã«ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã®çŠ¶æ…‹ã‚’ä¿å­˜ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨)
             savedCanvasImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
        } else {
            // ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ ã®å ´åˆã¯ã™ãã«æãå§‹ã‚ã‚‹
            ctx.strokeStyle = currentDrawTool === 'eraser' ? 'rgba(0,0,0,1)' : currentDrawColor;
            ctx.lineWidth = currentDrawThickness;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
        }
    }

    function draw(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;

        if (isRulerMode) {
             // 1. ä¿å­˜ã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
             ctx.putImageData(savedCanvasImage, 0, 0);

             // 2. ã‚¹ãƒŠãƒƒãƒ—ã•ã‚ŒãŸåº§æ¨™ã‚’è¨ˆç®—
             const snapped = getSnappedCoordinates(startX, startY, currentX, currentY);

             // 3. ã‚¹ãƒŠãƒƒãƒ—ã•ã‚ŒãŸç·šã‚’æç”»
             ctx.strokeStyle = currentDrawColor;
             ctx.lineWidth = currentDrawThickness;
             ctx.beginPath();
             ctx.moveTo(startX, startY);
             ctx.lineTo(snapped.x, snapped.y);
             ctx.stroke();

        } else {
            // ãƒšãƒ³/æ¶ˆã—ã‚´ãƒ ã®é€£ç¶šæç”»
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            lastX = currentX;
            lastY = currentY;
        }
    }

    function stopDrawing(e) {
        if (!isDrawing) return;
        isDrawing = false;
        
        // å®šè¦ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€æœ€å¾Œã«æã‹ã‚ŒãŸç·šã‚’ç¢ºå®šã•ã›ã‚‹
        if (isRulerMode) {
             // æœ€å¾Œã®ãƒã‚¦ã‚¹ä½ç½®ã§ç¢ºå®šç·šã‚’æç”»
             const rect = canvas.getBoundingClientRect();
             const endX = e.clientX - rect.left;
             const endY = e.clientY - rect.top;
             
             // ç¢ºå®šã™ã‚‹å‰ã«ã€ã‚‚ã†ä¸€åº¦ã‚¹ãƒŠãƒƒãƒ—ã•ã‚ŒãŸåº§æ¨™ã‚’è¨ˆç®—ã—ã¦æç”»
             ctx.putImageData(savedCanvasImage, 0, 0); // ãƒ™ãƒ¼ã‚¹ç”»åƒã‚’å†é©ç”¨
             const snapped = getSnappedCoordinates(startX, startY, endX, endY);
             
             ctx.strokeStyle = currentDrawColor;
             ctx.lineWidth = currentDrawThickness;
             ctx.beginPath();
             ctx.moveTo(startX, startY);
             ctx.lineTo(snapped.x, snapped.y);
             ctx.stroke();
             
             savedCanvasImage = null; // ãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾
        }

        // ä¿å­˜ã¯ã‚¿ã‚¤ãƒãƒ¼ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä¸è¦ã ãŒã€æç”»ãŒå®Œäº†ã—ãŸã“ã¨ã‚’é€šçŸ¥
        // showNotification('æç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); // é »ç¹ã™ãã‚‹ã®ã§ç„¡åŠ¹åŒ–
    }

    function setDrawColor(color) {
        currentDrawColor = color;
        // ãƒšãƒ³ãƒ¢ãƒ¼ãƒ‰ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚‰é€šçŸ¥
        if (currentDrawTool === 'pen') showNotification(`ãƒšãƒ³ã®è‰²ã‚’${color}ã«è¨­å®šã—ã¾ã—ãŸ`);
        document.querySelector('#draw-tab select:nth-of-type(1)').value = ''; 
    }
    
    function setDrawThickness(thickness) {
        currentDrawThickness = parseInt(thickness);
        showNotification(`ç·šã®å¤ªã•ã‚’${thickness}pxã«è¨­å®šã—ã¾ã—ãŸ`);
        document.querySelector('#draw-tab select:nth-of-type(2)').value = ''; 
    }
    
    // ğŸ¨ Canvasã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    function newMemo(showNotificationFlag = true) {
        saveCurrentMemo(); // ç¾åœ¨ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰
        editor.innerHTML = '';
        document.getElementById('font-size-input').value = '16'; // ã‚µã‚¤ã‚ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        currentMemoId = generateUUID(); // æ–°ã—ã„IDã‚’å‰²ã‚Šå½“ã¦
        localStorage.setItem(CURRENT_MEMO_ID_KEY, currentMemoId);
        showScreen('document'); // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ
        if (showNotificationFlag) {
            showNotification('æ–°ã—ã„ãƒ¡ãƒ¢ã‚’ä½œæˆã—ã¾ã—ãŸ');
        }
        // æ–°è¦è¿½åŠ : ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨draggable-elementã‚’ã‚¯ãƒªã‚¢
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        documentContainer.querySelectorAll('.draggable-element').forEach(el => el.remove());

        // æç”»ãƒ„ãƒ¼ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        currentDrawTool = null;
        document.querySelectorAll('#draw-tab button').forEach(btn => btn.classList.remove('active'));
        canvas.style.pointerEvents = 'none'; // ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ã«æˆ»ã™
        ctx.globalCompositeOperation = 'source-over'; 
    }
  </script>
</body>
</html>
